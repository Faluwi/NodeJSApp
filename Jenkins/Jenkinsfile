appName = "hello-world"

pipeline {
    // Use the 'node' Jenkins agent image which is provided with OpenShift 
    agent {label 'nodejs'}
    stages {
        stage("Testing") {
            steps {
                sh "echo 'Testing'"
                sh 'npm install'
                sh 'npm run lint'
            }
        }
        stage ("helm build") {
            agent {
                kubernetes {
                    yaml '''
                        apiVersion: v1
                        kind: Pod
                        spec:
                            containers:
                            -  name: helm-slave
                               image: docker.io/faluwi/jenkins-helm-agent:v0.1
                               imagePullPolicy: IfNotPresent
                               command:
                               - cat
                               tty: true
                               resources:
                                   limits: {}
                                   requests:
                                       memory: "256Mi"
                                       cpu: "100m"
                        '''
                }
            }
              steps {
                  container('helm-slave') { 
                     sh 'helm version'
                      script {
                          openshift.withCluster() {
                              sh "helm upgrade --install testsecret ./helm/testSecret -n faluwi-dev --wait"
                              sh "helm upgrade --install testnodebuild ./helm/testBuild -n faluwi-dev --wait"
                              openshift.withProject("faluwi-dev") {
                                openshift.selector("bc", "test-node-build").startBuild("--wait")
                              }
                              sh "helm upgrade --install testnode ./helm/testNode -n faluwi-dev --wait"
                          }
                      }
                  }
             }
        }
    }//Stages
}//Pipeline
